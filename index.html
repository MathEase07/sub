<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sa Huling Jeep ng Gabi — Subtitles</title>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --muted: rgba(255,255,255,0.65);
    }
    html,body {
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: "Arial", Helvetica, sans-serif;
    }
    .wrap {
      display:flex;
      flex-direction:column;
      height:100%;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
      text-align:center;
    }
    #subtitle {
      font-family: 'MistakeNote', "Segoe UI", Roboto, Arial, sans-serif;
      color: #ff0000; /* red */
      font-size: clamp(18px, 4vw, 30px);
      line-height:1.4;
      max-width: 92%;
      background: rgba(0,0,0,0.45);
      padding: 18px 22px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      transition: opacity .35s, transform .35s;
      opacity: 1;
    }
    #time {
      margin-top:12px;
      color: var(--muted);
      font-size: 0.85rem;
    }
    /* small helper for debugging */
    #debug {
      position:fixed;
      left:8px;
      bottom:8px;
      color:var(--muted);
      font-size:12px;
      opacity:0.9;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="subtitle">“Sa Huling Jeep ng Gabi”</div>
    <div id="time"></div>
  </div>
  <div id="debug" style="display:none;"></div>

<script>
/*
  Generated subtitles for "Sa Huling Jeep ng Gabi"
  - The script provided by the user was parsed as sequential phrases with durations (e.g., (3s)).
  - Each subtitle entry has a start time in seconds (cumulative) and the visible text (without the (Ns) markers).
  - Controls: App Inventor should set WebViewer.WebViewString to "play", "pause", or "stop".
  - There's also a setOffset(seconds) function to shift all subtitle timings (if audio has lead-in silence).
*/

/* === Subtitles array ===
   Each item: { t: <start seconds>, text: "<subtitle text>" }
   NOTE: I grouped phrases into readable subtitle lines while preserving timings.
*/
const subtitles = [
  /* I'll use the durations provided, accumulated to create start times.
     Start at 0. */
  { t: 0.0, text: "..." },

  // Narrator opening (broken into segments as in script)
  { t: 12.0, text: "Sa lahat ng hindi inaasahan sa buhay—tulad ng sabayang pagpatak ng ulan at LBM, o yung pag-message mo sa crush mo na isi-seen lang" },
  { t: 23.0, text: "Walang mas nakakagulat kaysa sa pagbabalik ng isang taong hindi mo na inakalang babalik pa." },
  { t: 31.0, text: "Ito ang kwento ni Bea… at ng isang jeepney ride na magbabago ng lahat." },

  { t: 37.0, text: "..." },

  // Next chunk: Narrator describing Bea on the jeep
  { t: 38.0, text: "Gabi na sa Sariaya. Si Bea, galing sa kanyang part-time, pagod, gutom, at basa sa ulan." },
  { t: 44.0, text: "Sa loob ng jeep, may apat na pasahero — isa ay tulog, isa kumakain ng fishball, at isa... ang ex niyang si Paolo." },

  { t: 51.0, text: "..." },

  // Short dialogue exchange
  { t: 71.0, text: "Ay wow. Si Mr. Ghoster. Buhay ka pa pala." },
  { t: 74.0, text: "Bea?! Uy, hala, ikaw nga! Grabe, ang ganda mo pa rin!" },
  { t: 75.0, text: "Wag mo akong daanin sa bola. Hindi ako siopao." },
// Parse the user's raw script (looks for patterns like "... (12s)") and auto-generate
// subtitle entries. This keeps the text in the HTML concise and makes it easy to update.
const rawScript = `
“Sa Huling Jeep ng Gabi"
[Sound effects: Crickets, distant barking dogs, tricycle engine passing. Soft acoustic guitar music fades in] (12s)
[Narrator]:
Sa lahat ng hindi inaasahan sa buhay, tulad ng sabayang pagpatak ng ulan at LBM, o yung pag-message mo sa crush mo na isi-seen lang (11s) — walang mas nakakagulat kaysa sa pagbabalik ng isang taong hindi mo na inakalang babalik pa.(8s)
Ito ang kwento ni Bea… at ng isang jeepney ride na magbabago ng lahat. (7s)
 [Sound effects: Ulan, jeepney engine starting, “para po!”]
[Narrator]:
Gabi na sa Sariaya.(2s) Si Bea, galing sa kanyang part-time, pagod, gutom, at basa sa ulan. (6s) Sa loob ng jeep, may tatlong pasahero (3s) — isa ay tulog,(2s) isa kumakain ng fishball,(2s) at isa... ang ex niyang si Paolo.(9s)
[Sound effects: Jeepney brake squeak. Background: light rain, tambucho noise.] (6s)
Bea (sarcastic):  Ay wow. (1s) Si Mr. Ghoster. (1s) Buhay ka pa pala.( 2s)
Paolo (shock): Bea?! (1s)  Uy, (1s) hala, ikaw nga! Grabe, ang ganda mo pa rin! (7s)
Bea (deadpan): Wag mo akong daanin sa bola. Hindi ako siopao.(8s)
 [Narrator]:
Bago pa mangyari ang lahat ng ‘to,  si Bea at si Paolo ay may kwento.  Isang kwento ng mga unang ngiti,  at ng mga unang halakhak sa gitna ng mga kape at kwentuhan. (10s) Nagkakilala sila sa isang coffee shop sa Barangay Poblacion 2, Sariaya, Quezon,(5s) sa likod ng Ongville, to be exact sa Brewleaf. (4s) — isang lugar na puno ng kwento,(1s) at puno ng tamis ng mga simula. (6s)
[Narrator]:
Si Beatriz Gabrielle Castillo, also known as Bea,  isang independent na babae, outgoing at madaldal. (8s) Siya yung tipo ng tao na laging game sa usapan,(4s) hindi nauubusan ng kwento, at mahilig magpuyat para mag-binge watch ng mga paborito niyang series hanggang madaling araw. (9s) Si Paolo Antonio Villanueva or Paolo, (4s) isang dedicated na athlete na laging puno ng energy. (4s) Medyo playful siya at mahilig magbiro, (3s) kaya kahit seryoso ang training ay nagagawa niyang gawing masaya ang paligid. (5s) Natural sa kanya ang pagiging palakaibigan, at may confidence siyang nakakahawa (5s) — tipong kaya niyang pasayahin ang kahit sinong kasama niya. (5s)
[Sound effects: The bell of the coffee shop rings as Paolo walks in. Bea is sipping her coffee.] (2s)
Paolo (playful, excited): Excuse me,  miss… may free WiFi ba dito? Kasi feeling ko mas mabilis ang connection kung sayo ako makikipag-usap. (9s)
Bea (smiling, sarcastic): Free WiFi?  Kung paanong libre ang utang ng mga kababayan mo sa mga kaibigan nila,  “free”  lang yan. (6s)
Paolo (laughing): Grabe ka naman, ha! Hindi ba pwedeng magtanong lang…(4s) syempre may kasamang charm,  para hindi lang ako sa court mabilis maka-score. (6s) Pwede ba maki-table?  Full-house na eh. I’m Paolo by the way (5s).
 [Sound effects: Trina’s voice in the background, teasing Bea.]
Trina (shouting from a table): Bea,  ayan na siya!  Baka ito siya na yung Mr. Right na hinahanap mo! Tall, check, mestizo, check, handsome, oh super check. Hindi mo ba siya tatanggapin? (11s)
Narrator (lightly):
Si Trina, ang best friend ni Bea,  ang palaging kasangga sa mga ganitong moments. Hindi siya tinatablan ng hiya at mahilig magbiro, lalo na kapag si Bea ang topic. (13s)
Bea (rolling her eyes, laughing): Trina, (1s) sobra ang pagka-OA ha! (3s) Ikalma mo and yes Paolo, (3s)  pwede ka maki-table. (2s) I’m Bea and itong OA na katabi ko,(3s) si Trina nga pala (2s)
Paolo (chuckling): Thanks. (1s) Wait, (1s) sabi na eh familiar ka! (2s) You’re Ms. Castillo, right? (2s) Si Ms. Top 1 since junior high school, (3 s) na kulang nalang i-perfect niya lahat ng quizzes and exams. (4s) It’s nice to finally meet my idol in person. (3s)
Bea: Yes, (1s) that’s me, (1s) Mr. MVP ng basketball ng intramurals 2024 (4s)
Trina: So ano ko dito?  Third wheel ganun? (6s)
[Narrator]:
Sinong maga-akala na dito na pala magsisimula ang pagkaka-ibigan, este pagkakaibigan ng dalawa.(7s) It was not hard na maging close yung dalawa, considering na they’re schoolmates from the same school and grade level. (7s)
Ano nga bang mangyayari sa kanilang friendship? We’ll be giving you the next latest tea of the story after this short break. (10s)
… Commercial (20s)
… Breaking News(46s)

Scene 2 (1s): The Confession (2s)
[Narrator]:
Simula ng araw na nagkausap sila sa Brewleaf(3s), the two of them got closer (3s). Nagkaroon na ng after-class tambayan(3s), paggala sa malls at mga bayan (2s), at napapadalas din ang pagmessage nila sa isa’t isa (4s) na para bang (1s) part na yon ng kanilang daily routine. (3s)
Jasper: Uy, manood kayo ng game namin ni Pao sa Sabado (3s) —championship na ‘to, at siguradong MVP na naman si Mr. Villanueva (4s), kahit minsan mas busy pa siya sa gala kaysa sa training.(4s)
[Narrator]:
Si Jasper, best friend ni Paolo simula pagkabata(5s), isa ring athlete pero mas chill at mahilig mang-asar(4s). Siya yung tipong barkada na laging may dalang punchline (4s), pero (1s) marunong ring sumuporta sa tamang oras (5s)
Trina: Tamang tama(2s), wala kaming gagawin ni Bea this weekend.(2s)
Bea: Si ate(1s), desisyon ka na naman sa buhay ko. (2s)
Trina: Pero aminin mo (2s), tama ako, right? (1s)
Bea: Oo na(2s), payag na(2s). See you sa weekends and good luck sa game. (4s)
Paolo: Thanks Bea(1s), gagalingan ko promise para sayo (2s) este (1s) para sa inyo syempre(3s). Para sa inyo I mean (3s), sa mga taong sumusuporta sa akin. (2s)
Jasper: Sus(1s), ayan ka na naman sa mga padale mo pare. (2s)
[Narrator]:
Dumating na ang game day (2s). Puno ang Complex ng sigawan(3s), pawis(1s), at kaba(1s) Jasper, the hype-man he is (2s), hindi mapigilang mang-asar sa bleachers (4s) habang si Bea naman (2s), nakaupo sa gitna ng crowd (2s)—hindi alam kung magfofocus ba sa scoreboard (3s) o sa bawat galaw ng isang tao(2s) : si Paolo Villanueva. (2s)
The game (1s) was intense (1s) sunod-sunod ang fast breaks, halos tabla ang score hanggang sa huling minuto (5s). Every dribble (1s), every shot (1s), ramdam ng lahat ang bigat(2s). At sa pinaka-kritikal na sandali (3s), Paolo sank the final basket (2s). Champion ang team(1s), at sa huli (1s), siya pa ang tinanghal na MVP (3s)
[SFX: Crowd cheering, whistles, tapos unti-unting humihina hanggang maging ambient city sounds] (12s)
[Narrator]:
 Pero imbes na mag-celebrate agad kasama ng teammates (4s), diretso siyang lumapit kay Bea (2s). Pawisan (1s), hingal(1s), pero may ngiti (1s) na parang mas panalo pa siya sa ibang bagay. (4s)
Paolo: So… Bea(1s). Tinupad ko na yung part ko(2s). Champion(1s), MVP(1s). Ikaw naman—tupadin mo naman yung pangako mo? (3s)
Bea: Anong pangako? (1s)
Paolo: Na kapag nanalo ako, lalabas ka with me after the game.(4s)
Bea: Grabe(1s), seryoso ka pala dun(2s)? Akala ko bola lang yun(2s), Villanueva.(1s)
Paolo: Hindi lahat ng bola dapat binibitawan(2s). So…(1s) are you coming with me(2s)?
Bea: Fine(1s). Pero wag mong isipin na ito yung typical na date ha(3s). Special request lang kasi MVP ka.(6s)
[Narration – transitioning tone]
 At nagsimula nga ang gabing iyon(3s) sa isang simpleng lakad(2s), pagkatapos ng ingay at sigawan ng court(3s). Sa ilalim ng mga ilaw sa bayan(3s), doon nagkaroon ng mas tahimik pero mas matinding laban(5s)—ang pag-amin ng dalawang pusong matagal nang naglalaro sa parehong laro(6s).
Paolo: Alam mo(1s), mas nakakakaba pa ata yung pagtingin mo habang naglalaro ako kaysa sa mismong championship game(5s).
Bea: Wow(1s), excuse me ha(1s). Hindi lahat ng tao nabubudol ng smile mo(3s). Besides(1s), I was just(1s)… observing(1s).
Paolo: Observing(1s)? Kasi ako, matagal ko nang na-observe(3s)… na iba ka(1s). Kahit ang ingay ng crowd kanina, ikaw yung napapansin ko(3s).
Bea: Ang dami mong bola, Villanueva(2s). Off the court pa rin ba yan?(3s)
Paolo: Hindi na to’ bola(1s), Bea(1s). Totoo(1s). Gusto kita(1s). Sa dami ng oras na magkasama tayo(2s)—kahit puro asaran(2s), kahit magkaiba tayo ng mundo(2s)—lagi kong hinahanap yung presence mo(2s).
Bea: Alam mo bang delikado yang sinasabi mo(3s)? Kasi(1s)… kapag sinabi kong gusto rin kita(2s), wala ka nang takas(2s).
Paolo: Eh(1s) ‘di sana matagal mo nang sinabi(2s), para mas matagal na akong masaya(2s).”
[SFX: Background fades into a soft instrumental music]
Bea: Okay fine, Villanueva(2s). Gusto rin kita(1s). At least ngayon(1s), stable na yung connection natin(4s).
 
Scene 3: Na para bang…
[Narrator]:

Yung akala ni bea na friendship, mauuwi pala sa relationship na sa bawat tawa, may lihim na palang nararamdaman, ano kayang mangyayari kapag ang kilig ay sinubok ng oras at distansya.15s We’ll be giving you the next latest after this short break.(9s)

…Commercial (22s)
Scene 3: Na para bang… (3s)
[Narrator]:
Sa mga susunod na linggo, para bang walang makakapigil kay Bea at Paolo (6s). Mapa-coffee shop man o post-game dinners, laging magkasama(6s). Sila yung tipo ng mag-jowa na hindi kailangan ng sobrang PDA (6s) — sapat na yung asaran, kulitan, at stolen glances para makita ng iba na mayroong spark. (15s)
[SFX: Tawanan, clinking coffee cups, basketball bouncing faintly in background]
[Narrator]:
 Pero sabi nga nila (2s), hindi lahat ng kwento laging masaya(3s). Unti-unti, may naramdaman si Bea na malamig na hangin sa pagitan nila. (9s)
Bea: Uy, akala ko kanina ka pa tapos sa training. Ilang beses na kitang tinext.(6s)
Paolo: Yeah, sorry(1s). Ang daming kailangan asikasuhin (2s). Coach, teammates… alam mo na. (7s)
[Narrator]:
Sa bawat araw na lumilipas mas naging bihira ang mga tawag, mas naging pormal ang mga sagot. (8s) Ang dati’y excited na Paolo (2s), ngayon parang laging may iniisip na iba.(3s) Hanggang sa isang araw (5s)
[SFX: Phone ringing, message tones, then silence] (20s)
[Narrator]”
 …wala na.(1s) Hindi na siya sumipot sa klase,(2s) hindi na siya nakikita sa court, (2s) at kahit ilang tawag at mensahe ang ipadala ni Bea,(5s) tanging katahimikan lang ang sagot (3s)  Parang sa isang iglap(2s) naglaho si Paolo Villanueva (2s) — at iniwan si Bea sa gitna ng lahat ng tanong na walang kasagutan. (5s)
Trina: Bea…(1s) wala pa rin ba? (2s) 
Bea: Wala.(1s) Parang… (2s) parang bigla na lang siyang nabura (3s). Kahapon lang (1s), nagpa-plano pa kami ng susunod na lakad.(3s) Tapos ngayon… (2s) wala na. (1s) Hindi man lang nagpaalam.(3s) 
Trina: Alam mo,  kung anuman yung pinagdadaanan niya, hindi tama na iwan ka niya ng ganito. (8s)
[Narration – softer, emotional tone]
 Pero kahit anong pilit ni Trina na gawing magaan ang pakiramdam niya, ramdam ni Bea ang bigat ng kawalan (8s).. Parang bawat kape na kanyang iniinom ay mas mapait (5s), bawat gabi ng binge-watch ay mas mahaba (4s), at bawat alaala ni Paolo ay parang sirang plaka na kahit anong gawin (7s), paulit-ulit sinasambit ang mga ala-alang hindi maibabalik. (7s)
Bea: Alam mo, Trina… (2s) akala ko stable na yung connection namin.(4s) Pero siguro…(2s) hindi pala ako sapat na signal para manatili siya. (6s)
[SFX: Long pause. Cup gently placed on the saucer. Background fades into silence, then slow, melancholic music.] 
[Narration – closing line, heavy but poetic]:
 Sa bawat pag alis may taong naiiwan At sa unang pagkakataon (2s), naiwan si Bea hindi sa gitna ng madaming tao (4s), kundi sa gitna ng sariling katahimikan — (4s)hawak-hawak ang tanong na… (3s)babalik pa kaya siya? (3s)
Magbabalik (11s)
Breaking News (47s)
Commercial (24s)
 
 Scene 4: Bumalik o nagparamdam lang? (3s)
[Narrator]:
Dalawang taon ang nakalipas simula ng nawala si Paolo. (4s) Nakagraduate na sila ng Senior High School at kasalukuyang mga first year na sila. (6s) Kumuha si Bea ng part-time kasi para sa kanya the more na maraming ginagawa baka sakaling mas madali mawala sa isipan niya ang taong iniwan siya sa ere. (12s) Isang mauling gabi, matapos ang kanyang shift sa Café Lokal. (6s)
Bea: Kung minamalas ka nga naman, (3s) kung kailan maulan tsaka ko pa nalimutan ang payong ko (4s). Hays ano ba yan! (10s)
[Narrator]:
Nagpunta siya sa terminal ng Guis-Guis,(3s) at sakto yun na ang last trip pauwi. (3s) Sumakay si Bea na pagod, gutom,  at basa mula sa ulan. (5s) Alas syete na noon,(2s) at bukod sa kanya tatlo pa lamang ang laman ng jeep.(4s) Isa sa pasahero nito ang naka-upo sa kanyang harapan.(4s) Isang taong hindi niya inaakalang babalik pa.(6s)
Bea: Ay wow.(1s) Si Mr. Ghoster. Buhay ka pa pala. (2s)
Paolo: Bea?! (1s) Uy, hala, ikaw nga! (2s) Grabe, ang ganda mo pa rin! (3s)
Bea: Wag mo akong daanin sa bola. (2s)Hindi ako siopao. (1s)
[Sound effects: Tawa ng ibang pasahero. Jeepney bumps. Someone says "lakasan mo 'yung radyo!"]**
[Narrator]:
Bea tried to look out the window, pretending Paolo was just some random guy na nagbayad ng kulang. But Paolo? Determined. Parang nagka-epiphany sa Sariaya traffic.
Paolo: Alam mo,(1s) ang tagal ko nang gusto kang kausapin.(3s)  'Di ko lang alam kung paano… (2s)
Bea: Two years, Paolo. (2s)  Ni “Happy Birthday,” wala. (2s)
Paolo: Nag-type ako nun... (2s) hindi ko lang na-send. (2s) [chuckles nervously]
Bea: Aba, grabe. (1s) Mahal na mahal mo pala ako... (2s) sa drafts. (1s)
[Sound effects: Jeepney conductor yelling “Oh Montecillio na baka may baba diyan!” Guitar music plays again lightly.] (6s)
...`;

// Regex: capture any segment that ends with (Ns) where N can be integer or decimal
const segmentRe = /([^\(]+?)\s*\((\d+(?:\.\d+)?)s\)/g;
let m, acc = 0, parsed = [];
while ((m = segmentRe.exec(rawScript)) !== null) {
  const rawText = m[1].trim();
  const dur = parseFloat(m[2]);
  // process text: remove leading speaker labels like "Bea:" or "Paolo:"
  let text = rawText.replace(/^\s*\[?\s*[A-Za-z0-9 _'"-]+\]?\s*:\s*/,'').trim();
  // detect SFX or sound-only lines
  const low = rawText.toLowerCase();
  if (low.includes('sound effects') || low.includes('[sfx') || low.includes('sfx:') || low.startsWith('[') && low.includes('sound')) {
    text = '...';
  }
  // if text becomes empty after stripping, use '...'
  if (!/[A-Za-zÀ-ÖØ-öø-ÿ]/.test(text)) text = '...';
  parsed.push({ t: acc, dur: dur, text });
  acc += dur;
}

// Build final subtitles array (start times and text only)
const subtitles = parsed.map(p => ({ t: p.t, text: p.text }));
  return null;
}

/* Render loop */
let lastShownIndex = -1;
function renderLoop() {
  const now = Date.now();
  const elapsed = (now - startEpoch) / 1000 + elapsedBefore;
  const sec = elapsed;
  const found = findCurrentSubtitle(sec);
  if (found) {
    if (found.index !== lastShownIndex) {
      lastShownIndex = found.index;
      const text = found.item.text;
      document.getElementById('subtitle').style.opacity = 0;
      // small delay for fade
      setTimeout(()=> {
        document.getElementById('subtitle').innerText = text;
        document.getElementById('subtitle').style.opacity = 1;
      }, 160);
    }
  }
  document.getElementById('time').innerText = formatSeconds(sec);
  raf = requestAnimationFrame(renderLoop);
}

/* Controls */
function doPlay() {
  if (!playing) {
    playing = true;
    startEpoch = Date.now();
    raf = requestAnimationFrame(renderLoop);
    // reveal first subtitle immediately if already within range
    lastShownIndex = -1;
  }
}

function doPause() {
  if (playing) {
    playing = false;
    elapsedBefore += (Date.now() - startEpoch) / 1000;
    if (raf) cancelAnimationFrame(raf);
  }
}

function doStop() {
  playing = false;
  elapsedBefore = 0;
  if (raf) cancelAnimationFrame(raf);
  lastShownIndex = -1;
  document.getElementById('subtitle').innerText = "Sa Huling Jeep ng Gabi";
  document.getElementById('time').innerText = "";
}

/* Optional: allow App Inventor to set an offset reset or set current time */
function setOffset(seconds) {
  offset = seconds;
}
function setTime(seconds) {
  // set the internal elapsed to `seconds` (useful if you get Player.CurrentPosition)
  elapsedBefore = seconds;
  if (playing) {
    startEpoch = Date.now();
  } else {
    // not playing — update display immediately
    lastShownIndex = -1;
    const found = findCurrentSubtitle(seconds);
    if (found) {
      document.getElementById('subtitle').innerText = found.item.text;
      document.getElementById('time').innerText = formatSeconds(seconds);
    }
  }
}

/* === Communication with MIT App Inventor ===
   MIT AI2 (WebViewer) can call setWebViewString to send commands.
   We'll poll window.AppInventor.getWebViewString() if available (common pattern).
   Accept commands:
     play  -> start/resume
     pause -> pause
     stop  -> stop/reset
     time:NNN -> set current time (in seconds)  e.g. "time:45.3"
     offset:NNN -> set timing offset in seconds (positive or negative)
*/
let lastCmd = "";

function processCommand(cmd) {
  if (!cmd) return;
  if (cmd === lastCmd) return; // nothing new
  lastCmd = cmd;
  // parse possible values
  if (cmd === "play") {
    doPlay();
  } else if (cmd === "pause") {
    doPause();
  } else if (cmd === "stop") {
    doStop();
  } else if (cmd.startsWith("time:")) {
    const v = parseFloat(cmd.split(":")[1]);
    if (!isNaN(v)) setTime(v);
  } else if (cmd.startsWith("offset:")) {
    const v = parseFloat(cmd.split(":")[1]);
    if (!isNaN(v)) setOffset(v);
  } else {
    // ignore unknown
    // show debug if needed
    //document.getElementById('debug').innerText = "Unknown cmd: " + cmd;
  }
}

/* Polling strategy (works for App Inventor WebViewer):
   App Inventor sets WebViewer.WebViewString to a value which becomes accessible via
   window.AppInventor.getWebViewString() inside the web page. We'll poll it every 300ms.
*/
function pollForCommands() {
  try {
    if (window.AppInventor && typeof window.AppInventor.getWebViewString === "function") {
      const cmd = window.AppInventor.getWebViewString();
      if (cmd && cmd.length) {
        processCommand(cmd.trim());
        // Clear webview string (if the environment supports set)
        if (typeof window.AppInventor.setWebViewString === "function") {
          window.AppInventor.setWebViewString(""); // reset on supported hosts
        }
      }
    } else {
      // fallback: some AI2 versions call setWebViewString with incoming messages,
      // but if not present, App Inventor can also call JS functions—however polling is safe.
    }
  } catch (e) {
    // ignore
  }
}
setInterval(pollForCommands, 300);

/* Expose functions for direct JS calling (if you want to call from App Inventor via EvaluateJavaScript) */
window.subtitleControls = {
  play: doPlay,
  pause: doPause,
  stop: doStop,
  setTime: setTime,
  setOffset: setOffset
};

/* initialize */
doStop(); // show initial message
</script>
</body>
</html>
